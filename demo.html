<!DOCTYPE html>
<html lang=""><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ph-listview Demo</title>

  <script src="../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="ph-listview.html">
  <link rel="import" href="../paper-radio-group/paper-radio-group.html">
  <link rel="import" href="../paper-radio-button/paper-radio-button.html">

  <style>
    fieldset {
      width: 90%;
      margin: 0px auto;
      border: 1px grey dashed;
      padding: 15px;
    }
    fieldset table tr td:nth-child(3) {
      width: 50%;
    }
    fieldset table tr td:nth-child(3) input {
      width: 100%;
    }
    fieldset #radio-group {
      text-align: center;
    }

    #listview-wrapper {
      position: relative;
      height: 60%;
      margin-top: 20px;
    }
  </style>
  <style is="custom-style">
  /* TODO(polyup): For speed, consider reworking these styles with .classes
                   and #ids rather than [attributes].
  */
  [layout] {
    @apply(--layout);
  }
  [layout][vertical] {
    @apply(--layout-vertical);
  }
  [fullbleed] {
    margin: 0;
    height:100vh;
  }
</style>
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
</head>
<body unresolved="" fullbleed="" layout="" vertical="">

  <template is="dom-bind" id="app">
    <fieldset>
      <legend>Configuration for <i>ph-listview</i></legend>

      <div id="radio-group">
        <paper-radio-group selected="welt" paper-radio-group-changed="feedSourceSelected">
          <paper-radio-button name="youtube">Popular YouTube Videos</paper-radio-button>
          <paper-radio-button name="welt">Welt.de RSS-Feed</paper-radio-button>
        </paper-radio-group>
      </div>

      <template is="dom-if" if="{{listViewConfig}}">
        <table>
          <!--
            We iterate over the config object which stores all properties provided by the component to have some
            comfortable input fields to play with. The array is build in the app.js file.
          -->
          <template is="dom-repeat" items="{{listViewConfig}}" as="prop">
            <tr>
              <td>{{ prop.name }}</td>
              <td>=</td>
              <td><input type="text" value="{{prop.value::input}}" on-keyup="itemChanged" data-prop$="{{prop.name}}"></td>
              <td>&nbsp;</td>
              <td>{{ prop.validPublishValues }}</td>
            </tr>
          </template>
        </table>
      </template>
    </fieldset>

    <!-- this is our component wrapper to properly place the component on the page -->
    <div id="listview-wrapper">
      <!-- the main component is here and is configured by data-binding which is also set in app.js -->
      <!-- camelcase is translated to hyphen -->
      <ph-listview id="listView" view-type="{{listViewAttributes.viewType}}" feed="{{listViewAttributes.feed}}" handle-as="{{listViewAttributes.handleAs}}" sort-by-date-asc="{{listViewAttributes.sortByDateAsc}}">
      </ph-listview>
    </div>
  </template>

  <script>
    (function (document) {
      'use strict';
      // Grab a reference to our auto-binding template
      // and give it some initial binding values
      // Learn more about auto-binding templates at http://goo.gl/Dx1u2g
      var app = document.querySelector('#app');
      var firstRun = function () {
        console.log('Our app is ready to rock!');
        // add some data-binding variables to the bound template
        app.listViewConfig = [];
        app.listViewAttributes = {};
        // initialize and show YouTube list first
        //initListViewYouTube();
        initListViewRSS();
        initUserConfigParameters();
      };
      // Listen for WebComponentsReady event to know when bindings
      // have resolved and content has been stamped to the page
      window.addEventListener('WebComponentsReady', function () {
        firstRun();
        app.feedSourceSelected = function (event, detail, sender) {
          var selected = detail.item.attributes.name.value;
          if (selected === 'youtube') {
            initListViewYouTube();
          } else if (selected === 'welt') {
            initListViewRSS();
          }
          initUserConfigParameters();
        };
      });
      // event callback which is invoked when the radio button is tapped/clicked
      app.itemChanged = function (event, detail, sender) {
        var propName = sender.attributes['data-prop'].value;
        // propName has changed
        app.listViewAttributes[propName] = sender.value;
      };
      // configures the user input fields with the default values
      var initUserConfigParameters = function () {
        var publishedProps = document.querySelector('#listView').properties;
        var validPropValues = {
          feed: 'any URL',
          handleAs: 'rss || json || xml (depends on URLs response type)',
          viewType: 'default || compact',
          sortByDateAsc: 'true || false'
        };
        var arr = [];
        for (var propName in publishedProps) {
          arr.push({
            name: propName,
            value: app.listViewAttributes[propName],
            validPublishValues: validPropValues[propName]
          });
        }
        app.listViewConfig = arr;
      };
      // inits the component with an example RSS feed
      var initListViewRSS = function () {
        app.listViewAttributes = {
          feed: 'http://www.welt.de/wirtschaft/webwelt/?service=Rss',
          handleAs: 'rss',
          viewType: 'default',
          sortByDateAsc: 'true'
        };
      };
      // inits the component with an example / custom XML feed
      var initListViewYouTube = function () {
        // Configure how to handle the response and return the result array
        app.$.listView.setResponseParseFunc(function (response) {
          var xmlNodeTree = Polymer.dom(response).querySelectorAll('entry');
          // we only use the <entry>s
          var entries = [];
          for (var i = 0; i < xmlNodeTree.length; i++) {
            var node = xmlNodeTree[i];
            var media = Polymer.dom(node).querySelector('group');
            entries.push({
              title: Polymer.dom(Polymer.dom(node).querySelector('title')).textContent,
              date: Polymer.dom(Polymer.dom(node).querySelector('published')).textContent,
              link: Polymer.dom(node).querySelector('link[rel="alternate"]').getAttribute('href'),
              rating: Polymer.dom(node).querySelector('rating').getAttribute('average'),
              viewCount: Polymer.dom(node).querySelector('statistics').getAttribute('viewCount'),
              category: Polymer.dom(media).querySelector('category').getAttribute('label'),
              description: Polymer.dom(Polymer.dom(media).querySelector('description')).textContent,
              duration: Polymer.dom(media).querySelector('duration').getAttribute('seconds'),
              thumb: Polymer.dom(media).querySelectorAll('thumbnail')[0].getAttribute('url')
            });
          }
          return entries;
        });
        app.listViewAttributes = {
          feed: 'http://gdata.youtube.com/feeds/api/videos/',
          handleAs: 'xml',
          viewType: 'default',
          sortByDateAsc: false
        };
      };
    }(document));
  </script>
</body>
